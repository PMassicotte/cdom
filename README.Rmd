---
bibliography: /home/persican/Documents/library.bib
output:
  md_document:
    variant: markdown_github
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

```{r setup, echo = FALSE}
library(ggplot2)
theme_set(theme_bw(base_size = 12, base_family = "Open Sans"))
```

[![Travis-CI Build Status](https://travis-ci.org/PMassicotte/cdom.svg?branch=master)](https://travis-ci.org/PMassicotte/cdom)

# CDOM

The **cdom** package implements various functions used to model and calculate metrics from absorption spectra of chromophotic dissolved organic matter (CDOM).

This package provides:

1. Simple wrappers to calculate common metrics found in the literature.
    + The **spectral curve** [@Loiselle2009].
    + The **slope ratio (Sr)** [@Helms2008].
    + The **spectral slope (S)** [@Jerlov1968; @Lundgren1976; @Bricaud1981].

2. The function to use the **Gaussian decomposition approach** proposed in Massicotte and Markager, (2015).

The package can be installed using the following command.

```{r install, eval = FALSE}
devtools::install_github("PMassicotte/cdom")
```

Please note that this is a developing version of the package for testing only. Please fill an issue when you find bugs.

# Examples

## The spectral slope (S)

The `fit_exponential()` function fits an exponential curve to CDOM data using the simple model proposed by @Jerlov1968, @Lundgren1976, @Bricaud1981.

```tex
a(\lambda) = a(\lambda0)e^{-S(\lambda - \lambda0)} + K
```

```{r exponential}
library(ggplot2)
library(cdom)
data("spectra")

fit <- fit_exponential(wl = spectra$wavelength,
                       absorbance = spectra$spc3,
                       wl0 = 350,
                       startwl = 190,
                       endwl = 900)

ggplot(spectra, aes(x = wavelength, y = spc3)) +
  geom_point() +
  geom_line(aes(y = predict(fit)), col = "red") +
  xlab("Wavelength (nm)") +
  ylab(expression(paste("Absorption (", m ^ {-1}, ")")))

```

## The slope ratio (SR)

The `slope_ratio()` function calculates the slope ratio (S<sub>R</sub>) which is defined as: S<sub>275-295</sub>/S<sub>350-400</sub>. See @Helms2008 for detailed information.

```{r sr}
library(cdom)
data("spectra")

slope_ratio(spectra$wavelength, spectra$spc1)
```

## The spectral curve

The `spectral_curve()` function generates the spectral curve using the slope of the linear regression between the natural log absorption spectrum and wavelengths over a sliding window of 21 nm interval (default) at 1 nm resolution. See @Loiselle2009 for detailed information.

```{r spectral_curve}
library(cdom)
data("spectra")

res <-  spectral_curve(wl = spectra$wavelength,
                       absorbance = spectra$spc10,
                       interval = 21,
                       r2threshold = 0.98)

ggplot(res, aes(x = wl, y = s)) +
  geom_line() +
  xlab("Wavelength (nm)") +
  ylab(expression(paste("Spectral slope (", nm ^ {-1}, ")")))

```

# Data

A total 25 absorption spectra are provided in the package.

```{r data}
library(ggplot2)
library(tidyr)
data("spectra")

spectra <- gather(spectra, sample, absorption, -wavelength)
ggplot(spectra, aes(x = wavelength, y = absorption, group = sample)) +
  geom_line(size = 0.1) +
  xlab("Wavelength (nm)") +
  ylab(expression(paste("Absorption (", m ^ {-1}, ")")))
```

# References
